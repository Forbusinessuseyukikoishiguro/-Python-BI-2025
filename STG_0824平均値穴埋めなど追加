"""
Tableau Excel ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ãƒ„ãƒ¼ãƒ« GUIç‰ˆï¼ˆãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ä¿®æ­£ç‰ˆï¼‰
Author: Claude
Description: Excelãƒ‡ãƒ¼ã‚¿ã‚’Tableauåˆ†æç”¨ã«åŠ¹ç‡çš„ã«å‰å‡¦ç†ã™ã‚‹ãŸã‚ã®GUIãƒ„ãƒ¼ãƒ«
"""

import pandas as pd
import numpy as np
import os
import tkinter as tk
from tkinter import ttk, filedialog, messagebox, scrolledtext
from datetime import datetime
from typing import List, Dict, Optional, Union, Any
import warnings
warnings.filterwarnings('ignore')


class TableauPreprocessorGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("ğŸ“Š Tableau Excelå‰å‡¦ç†ãƒ„ãƒ¼ãƒ«")
        self.root.geometry("1400x800")
        self.root.configure(bg='#f0f0f0')
        
        # ãƒ‡ãƒ¼ã‚¿é–¢é€£å¤‰æ•°
        self.data = None
        self.original_data = None
        self.data_info = {}
        self.processing_log = []
        self.file_path = None
        
        # ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        self.setup_styles()
        
        # GUIæ§‹ç¯‰
        self.create_widgets()
        
        # åˆæœŸçŠ¶æ…‹è¨­å®šï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼‰
        self.update_button_states()
        self.force_enable_all_export_buttons_startup()
    
    def setup_styles(self):
        """ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š"""
        self.style = ttk.Style()
        
        # ãƒ†ãƒ¼ãƒè¨­å®š
        available_themes = self.style.theme_names()
        if 'clam' in available_themes:
            self.style.theme_use('clam')
        
        # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«
        self.style.configure('Title.TLabel', font=('Arial', 16, 'bold'))
        self.style.configure('Heading.TLabel', font=('Arial', 12, 'bold'))
        self.style.configure('Action.TButton', font=('Arial', 10, 'bold'))
        self.style.configure('Export.TButton', font=('Arial', 11, 'bold'), foreground='white')
    
    def create_widgets(self):
        """GUIã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆ"""
        # ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ 
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # ã‚°ãƒªãƒƒãƒ‰è¨­å®š
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(1, weight=1)
        main_frame.rowconfigure(1, weight=1)
        
        # ãƒ˜ãƒƒãƒ€ãƒ¼
        header_frame = ttk.Frame(main_frame)
        header_frame.grid(row=0, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 10))
        
        title_label = ttk.Label(header_frame, text="ğŸ“Š Tableau Excelå‰å‡¦ç†ãƒ„ãƒ¼ãƒ«", style='Title.TLabel')
        title_label.pack()
        
        subtitle_label = ttk.Label(header_frame, text="Excelãƒ‡ãƒ¼ã‚¿ã‚’Tableauåˆ†æç”¨ã«åŠ¹ç‡çš„ã«ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ»å¤‰æ›")
        subtitle_label.pack()
        
        # å·¦å´ãƒ‘ãƒãƒ«ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰
        self.create_control_panel(main_frame)
        
        # å³å´ãƒ‘ãƒãƒ«ï¼ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼‰
        self.create_data_panel(main_frame)
    
    def create_control_panel(self, parent):
        """å·¦å´ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‚’ä½œæˆ"""
        control_frame = ttk.Frame(parent, width=380)
        control_frame.grid(row=1, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), padx=(0, 10))
        control_frame.grid_propagate(False)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³
        file_section = ttk.LabelFrame(control_frame, text="ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ", padding="10")
        file_section.pack(fill=tk.X, pady=(0, 10))
        
        self.file_label = ttk.Label(file_section, text="ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“", foreground='gray')
        self.file_label.pack(fill=tk.X, pady=(0, 5))
        
        file_button_frame = ttk.Frame(file_section)
        file_button_frame.pack(fill=tk.X)
        
        self.load_button = ttk.Button(file_button_frame, text="ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ", 
                                     command=self.load_file, style='Action.TButton')
        self.load_button.pack(side=tk.LEFT, padx=(0, 5))
        
        self.reload_button = ttk.Button(file_button_frame, text="ğŸ”„ å†èª­ã¿è¾¼ã¿", 
                                       command=self.reload_file, state='disabled')
        self.reload_button.pack(side=tk.LEFT)
        
        # ãƒ‡ãƒ¼ã‚¿æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        info_section = ttk.LabelFrame(control_frame, text="ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ¦‚è¦", padding="10")
        info_section.pack(fill=tk.X, pady=(0, 10))
        
        self.info_text = tk.Text(info_section, height=8, font=('Consolas', 9), 
                                state='disabled', bg='#f8f8f8')
        self.info_text.pack(fill=tk.BOTH)
        
        # ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        cleaning_section = ttk.LabelFrame(control_frame, text="ğŸ§¹ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°", padding="10")
        cleaning_section.pack(fill=tk.X, pady=(0, 10))
        
        self.empty_rows_button = ttk.Button(cleaning_section, text="ç©ºè¡Œå‰Šé™¤", 
                                           command=self.remove_empty_rows, state='disabled')
        self.empty_rows_button.pack(fill=tk.X, pady=2)
        
        self.empty_cols_button = ttk.Button(cleaning_section, text="ç©ºåˆ—å‰Šé™¤", 
                                           command=self.remove_empty_columns, state='disabled')
        self.empty_cols_button.pack(fill=tk.X, pady=2)
        
        self.duplicates_button = ttk.Button(cleaning_section, text="é‡è¤‡è¡Œå‰Šé™¤", 
                                           command=self.remove_duplicates, state='disabled')
        self.duplicates_button.pack(fill=tk.X, pady=2)
        
        self.missing_button = ttk.Button(cleaning_section, text="æ¬ æå€¤å‡¦ç†", 
                                        command=self.fill_missing_dialog, state='disabled')
        self.missing_button.pack(fill=tk.X, pady=2)
        
        self.missing_analysis_button = ttk.Button(cleaning_section, text="ğŸ“Š æ¬ æå€¤åˆ†æ", 
                                                 command=self.show_missing_analysis, state='disabled')
        self.missing_analysis_button.pack(fill=tk.X, pady=2)
        
        # å¤‰æ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        transform_section = ttk.LabelFrame(control_frame, text="ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¤‰æ›", padding="10")
        transform_section.pack(fill=tk.X, pady=(0, 10))
        
        self.text_clean_button = ttk.Button(transform_section, text="ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢", 
                                           command=self.clean_text_data, state='disabled')
        self.text_clean_button.pack(fill=tk.X, pady=2)
        
        self.type_convert_button = ttk.Button(transform_section, text="å‹å¤‰æ›", 
                                             command=self.convert_data_types, state='disabled')
        self.type_convert_button.pack(fill=tk.X, pady=2)
        
        self.rename_button = ttk.Button(transform_section, text="åˆ—åå¤‰æ›´", 
                                       command=self.rename_columns_dialog, state='disabled')
        self.rename_button.pack(fill=tk.X, pady=2)
        
        self.filter_button = ttk.Button(transform_section, text="ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿", 
                                       command=self.filter_data_dialog, state='disabled')
        self.filter_button.pack(fill=tk.X, pady=2)
        
        # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¿®æ­£ç‰ˆãƒ»å¸¸ã«è¡¨ç¤ºï¼‰
        export_section = ttk.LabelFrame(control_frame, text="ğŸ’¾ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›", padding="15")
        export_section.pack(fill=tk.X, pady=(0, 10))
        
        # ===== ãƒ¡ã‚¤ãƒ³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆå¤§ããç›®ç«‹ãŸã›ã‚‹ãƒ»å¸¸ã«æœ‰åŠ¹ï¼‰=====
        main_export_frame = ttk.Frame(export_section)
        main_export_frame.pack(fill=tk.X, pady=(0, 15))
        
        self.main_export_button = tk.Button(main_export_frame, 
                                           text="ğŸ“„ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹", 
                                           command=self.safe_export_data,
                                           font=('Arial', 12, 'bold'),
                                           bg='#4CAF50',
                                           fg='white',
                                           activebackground='#45a049',
                                           relief='raised',
                                           bd=3,
                                           height=2,
                                           state='normal')  # å¸¸ã«æœ‰åŠ¹
        self.main_export_button.pack(fill=tk.X, pady=5)
        
        # å€‹åˆ¥ä¿å­˜ãƒœã‚¿ãƒ³
        individual_frame = ttk.LabelFrame(export_section, text="å€‹åˆ¥ä¿å­˜", padding="10")
        individual_frame.pack(fill=tk.X, pady=(0, 10))
        
        export_buttons_frame = ttk.Frame(individual_frame)
        export_buttons_frame.pack(fill=tk.X, pady=(0, 10))
        
        self.export_excel_button = tk.Button(export_buttons_frame, text="ğŸ“Š Excelä¿å­˜", 
                                             command=self.quick_export_excel, 
                                             state='normal',  # å¸¸ã«æœ‰åŠ¹
                                             font=('Arial', 10),
                                             bg='#2196F3',
                                             fg='white',
                                             width=12,
                                             relief='raised',
                                             bd=2)
        self.export_excel_button.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 5))
        
        self.export_csv_button = tk.Button(export_buttons_frame, text="ğŸ“„ CSVä¿å­˜", 
                                           command=self.quick_export_csv, 
                                           state='normal',  # å¸¸ã«æœ‰åŠ¹
                                           font=('Arial', 10),
                                           bg='#FF9800',
                                           fg='white',
                                           width=12,
                                           relief='raised',
                                           bd=2)
        self.export_csv_button.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        # å¼·åˆ¶æœ‰åŠ¹åŒ–ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        debug_frame = ttk.Frame(individual_frame)
        debug_frame.pack(fill=tk.X, pady=(5, 0))
        
        self.force_enable_button = ttk.Button(debug_frame, text="ğŸ”§ ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–", 
                                             command=self.force_enable_export,
                                             style='Action.TButton')
        self.force_enable_button.pack(side=tk.LEFT, padx=(0, 5))
        
        self.test_button = ttk.Button(debug_frame, text="ğŸ” çŠ¶æ…‹ç¢ºèª", 
                                     command=self.test_data_status)
        self.test_button.pack(side=tk.LEFT)
        
        # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š
        settings_frame = ttk.LabelFrame(export_section, text="ä¿å­˜è¨­å®š", padding="10")
        settings_frame.pack(fill=tk.X, pady=(0, 10))
        
        # ä¿å­˜å½¢å¼é¸æŠ
        format_frame = ttk.Frame(settings_frame)
        format_frame.pack(fill=tk.X, pady=(0, 5))
        
        ttk.Label(format_frame, text="å½¢å¼:", font=('Arial', 9, 'bold')).pack(anchor=tk.W)
        self.export_format = tk.StringVar(value="excel")
        
        format_radio_frame = ttk.Frame(settings_frame)
        format_radio_frame.pack(fill=tk.X, pady=(0, 5))
        
        ttk.Radiobutton(format_radio_frame, text="Excel (.xlsx)", 
                       variable=self.export_format, value="excel").pack(anchor=tk.W, padx=10)
        ttk.Radiobutton(format_radio_frame, text="CSV (.csv)", 
                       variable=self.export_format, value="csv").pack(anchor=tk.W, padx=10)
        
        # è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        self.include_summary = tk.BooleanVar(value=True)
        self.include_log = tk.BooleanVar(value=True)
        
        ttk.Checkbutton(settings_frame, text="å‡¦ç†ã‚µãƒãƒªãƒ¼ã‚’å«ã‚ã‚‹", 
                       variable=self.include_summary).pack(anchor=tk.W)
        ttk.Checkbutton(settings_frame, text="å‡¦ç†ãƒ­ã‚°ã‚’å«ã‚ã‚‹", 
                       variable=self.include_log).pack(anchor=tk.W)
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆå¸¸ã«ãƒã‚¸ãƒ†ã‚£ãƒ–ï¼‰
        self.export_status = ttk.Label(export_section, 
                                      text="âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œæ¨å¥¨ï¼‰", 
                                      foreground='green', font=('Arial', 9))
        self.export_status.pack(pady=(10, 0))
        
        # ãã®ä»–ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        other_section = ttk.LabelFrame(control_frame, text="ğŸ”§ ãã®ä»–", padding="10")
        other_section.pack(fill=tk.X, pady=(0, 10))
        
        self.reset_button = ttk.Button(other_section, text="ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ", 
                                      command=self.reset_data, state='disabled')
        self.reset_button.pack(fill=tk.X, pady=2)
        
        self.log_button = ttk.Button(other_section, text="ğŸ“‹ å‡¦ç†ãƒ­ã‚°è¡¨ç¤º", 
                                    command=self.show_processing_log, state='disabled')
        self.log_button.pack(fill=tk.X, pady=2)
    
    def create_data_panel(self, parent):
        """å³å´ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ‘ãƒãƒ«ã‚’ä½œæˆ"""
        data_frame = ttk.Frame(parent)
        data_frame.grid(row=1, column=1, sticky=(tk.W, tk.E, tk.N, tk.S))
        data_frame.columnconfigure(0, weight=1)
        data_frame.rowconfigure(1, weight=1)
        
        # ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ˜ãƒƒãƒ€ãƒ¼
        data_header = ttk.Label(data_frame, text="ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼", style='Heading.TLabel')
        data_header.grid(row=0, column=0, sticky=tk.W, pady=(0, 5))
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
        self.create_data_table(data_frame)
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼
        status_frame = ttk.Frame(data_frame)
        status_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(5, 0))
        status_frame.columnconfigure(0, weight=1)
        
        self.status_label = ttk.Label(status_frame, text="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„")
        self.status_label.grid(row=0, column=0, sticky=tk.W)
        
        # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
        self.progress_var = tk.DoubleVar()
        self.progress_bar = ttk.Progressbar(status_frame, variable=self.progress_var, 
                                          maximum=100, length=200)
        self.progress_bar.grid(row=0, column=1, sticky=tk.E)
    
    def create_data_table(self, parent):
        """ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"""
        table_frame = ttk.Frame(parent)
        table_frame.grid(row=1, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        table_frame.columnconfigure(0, weight=1)
        table_frame.rowconfigure(0, weight=1)
        
        # Treeviewã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
        self.tree = ttk.Treeview(table_frame, show='tree headings', height=20)
        self.tree.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼
        v_scrollbar = ttk.Scrollbar(table_frame, orient=tk.VERTICAL, command=self.tree.yview)
        v_scrollbar.grid(row=0, column=1, sticky=(tk.N, tk.S))
        self.tree.configure(yscrollcommand=v_scrollbar.set)
        
        h_scrollbar = ttk.Scrollbar(table_frame, orient=tk.HORIZONTAL, command=self.tree.xview)
        h_scrollbar.grid(row=1, column=0, sticky=(tk.W, tk.E))
        self.tree.configure(xscrollcommand=h_scrollbar.set)
    
    def load_file(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€"""
        file_path = filedialog.askopenfilename(
            title="Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ",
            filetypes=[
                ("ã™ã¹ã¦å¯¾å¿œå½¢å¼", "*.xlsx;*.xls;*.csv;*.tsv;*.txt"),
                ("Excel files", "*.xlsx *.xls"),
                ("CSV files", "*.csv"),
                ("TSV files", "*.tsv"),
                ("Text files", "*.txt"),
                ("All files", "*.*")
            ]
        )
        
        if file_path:
            self.file_path = file_path
            try:
                self.load_data()
            except Exception as e:
                self.show_detailed_error("ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼", str(e))
    
    def load_data(self):
        """ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"""
        try:
            self.update_status("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...")
            self.progress_var.set(10)
            self.root.update()
            
            # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
            if not os.path.exists(self.file_path):
                raise FileNotFoundError(f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {self.file_path}")
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã‚’å–å¾—
            file_extension = os.path.splitext(self.file_path)[1].lower()
            self.progress_var.set(20)
            self.root.update()
            
            print(f"DEBUG: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹ - {self.file_path}")
            print(f"DEBUG: æ‹¡å¼µå­: {file_extension}")
            
            # Excelå½¢å¼ã®èª­ã¿è¾¼ã¿
            if file_extension in ['.xlsx', '.xls']:
                self.data = self.load_excel_file()
            # CSVå½¢å¼ã®èª­ã¿è¾¼ã¿  
            elif file_extension == '.csv':
                self.data = self.load_csv_with_multiple_encodings()
            # TSVå½¢å¼ã®èª­ã¿è¾¼ã¿
            elif file_extension in ['.tsv', '.txt']:
                self.data = self.load_csv_with_multiple_encodings(separator='\t')
            # ä¸æ˜ãªå½¢å¼ï¼ˆCSVå½¢å¼ã¨ã—ã¦è©¦è¡Œï¼‰
            else:
                print(f"WARNING: ä¸æ˜ãªæ‹¡å¼µå­ {file_extension}ã€CSVå½¢å¼ã§è©¦è¡Œ")
                self.data = self.load_csv_with_multiple_encodings()
            
            self.progress_var.set(70)
            self.root.update()
            
            # ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬æ¤œè¨¼
            if self.data is None or self.data.empty:
                raise ValueError("èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™")
            
            print(f"DEBUG: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ - {self.data.shape[0]}è¡Œ Ã— {self.data.shape[1]}åˆ—")
            
            # ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬æ•´ç†
            self.clean_loaded_data()
            
            # å…ƒãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            self.original_data = self.data.copy()
            
            # GUIæ›´æ–°
            self.on_data_loaded()
            
        except Exception as e:
            print(f"ERROR: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•— - {str(e)}")
            self.show_detailed_error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", str(e))
            self.progress_var.set(0)
    
    def load_excel_file(self):
        """Excelå½¢å¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€"""
        engines = ['openpyxl', 'xlrd']
        
        for engine in engines:
            try:
                print(f"DEBUG: Excelèª­ã¿è¾¼ã¿è©¦è¡Œ - engine: {engine}")
                
                # åŸºæœ¬çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§èª­ã¿è¾¼ã¿
                data = pd.read_excel(
                    self.file_path, 
                    engine=engine,
                    na_values=['', 'NULL', 'null', 'None', 'none', 'NaN', 'nan', '#N/A', '#VALUE!'],
                    keep_default_na=True
                )
                
                print(f"SUCCESS: Excelèª­ã¿è¾¼ã¿æˆåŠŸ - engine: {engine}")
                return data
                
            except ImportError:
                print(f"WARNING: ã‚¨ãƒ³ã‚¸ãƒ³ {engine} ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")
                continue
            except Exception as e:
                print(f"WARNING: ã‚¨ãƒ³ã‚¸ãƒ³ {engine} ã§å¤±æ•—: {str(e)}")
                continue
        
        # å…¨ã¦ã®ã‚¨ãƒ³ã‚¸ãƒ³ã§å¤±æ•—ã—ãŸå ´åˆã€pandasã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è©¦è¡Œ
        try:
            print("DEBUG: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ Excelèª­ã¿è¾¼ã¿è©¦è¡Œ")
            data = pd.read_excel(self.file_path)
            print("SUCCESS: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ Excelèª­ã¿è¾¼ã¿æˆåŠŸ")
            return data
        except Exception as e:
            print(f"ERROR: å…¨ã¦ã®Excelã‚¨ãƒ³ã‚¸ãƒ³ã§å¤±æ•—: {str(e)}")
            raise Exception(f"Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\n{str(e)}\n\nCSVå½¢å¼ã§ä¿å­˜ã—ç›´ã—ã¦è©¦ã—ã¦ãã ã•ã„ã€‚")
    
    def load_csv_with_multiple_encodings(self, separator=','):
        """è¤‡æ•°ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§CSVèª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ"""
        encodings = [
            'utf-8-sig',  # BOMä»˜ãUTF-8
            'utf-8',      # UTF-8
            'shift_jis',  # Shift-JIS (Windowsæ—¥æœ¬èª)
            'cp932',      # Windowsæ—¥æœ¬èª
            'iso-2022-jp', # JIS
            'euc-jp',     # EUC-JP
            'latin1',     # Latin-1
            'cp1252',     # Windows Western
        ]
        
        separators = [separator, ',', '\t', ';', '|'] if separator == ',' else [separator]
        
        for encoding in encodings:
            for sep in separators:
                try:
                    print(f"TRY: CSVèª­ã¿è¾¼ã¿ (encoding: {encoding}, separator: '{sep}')")
                    
                    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
                    csv_params = {
                        'encoding': encoding,
                        'sep': sep,
                        'na_values': ['', 'NULL', 'null', 'None', 'none', 'NaN', 'nan', '#N/A', '#VALUE!'],
                        'keep_default_na': True,
                        'skipinitialspace': True,
                        'skip_blank_lines': True,
                    }
                    
                    # æœ€åˆã®æ•°è¡Œã§åŒºåˆ‡ã‚Šæ–‡å­—ã‚’è‡ªå‹•åˆ¤å®š
                    if sep == ',' and separator == ',':
                        # è‡ªå‹•åˆ¤å®šã‚’è©¦è¡Œ
                        with open(self.file_path, 'r', encoding=encoding) as f:
                            sample = f.read(1024)
                            if sample.count('\t') > sample.count(','):
                                csv_params['sep'] = '\t'
                            elif sample.count(';') > sample.count(','):
                                csv_params['sep'] = ';'
                    
                    data = pd.read_csv(self.file_path, **csv_params)
                    
                    # ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
                    if not data.empty and len(data.columns) > 1:
                        print(f"SUCCESS: CSVèª­ã¿è¾¼ã¿æˆåŠŸ (encoding: {encoding}, sep: '{csv_params['sep']}')")
                        return data
                        
                except UnicodeDecodeError:
                    continue
                except Exception as e:
                    print(f"WARNING: {encoding}/{sep} ã§å¤±æ•—: {e}")
                    continue
        
        raise Exception(f"ã™ã¹ã¦ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»åŒºåˆ‡ã‚Šæ–‡å­—ã§èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
    
    def clean_loaded_data(self):
        """èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬æ•´ç†"""
        try:
            # åˆ—åã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ»ä¿®æ­£
            if self.data.columns.duplicated().any():
                print("INFO: é‡è¤‡åˆ—åã‚’ä¿®æ­£")
                new_columns = []
                seen = {}
                for col in self.data.columns:
                    if col in seen:
                        seen[col] += 1
                        new_columns.append(f"{col}_{seen[col]}")
                    else:
                        seen[col] = 0
                        new_columns.append(col)
                self.data.columns = new_columns
            
            # å®Œå…¨ã«ç©ºã®è¡Œãƒ»åˆ—ã‚’å‰Šé™¤
            initial_shape = self.data.shape
            self.data = self.data.dropna(how='all', axis=0)  # ç©ºè¡Œå‰Šé™¤
            self.data = self.data.dropna(how='all', axis=1)  # ç©ºåˆ—å‰Šé™¤
            
            if self.data.shape != initial_shape:
                print(f"INFO: ç©ºè¡Œãƒ»åˆ—ã‚’å‰Šé™¤ {initial_shape} â†’ {self.data.shape}")
            
            # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            self.data = self.data.reset_index(drop=True)
            
        except Exception as e:
            print(f"WARNING: ãƒ‡ãƒ¼ã‚¿æ•´ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: {str(e)}")
            # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶šè¡Œ
    
    def show_detailed_error(self, title, error_message):
        """è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"""
        detailed_msg = f"âŒ {title}\n\n"
        detailed_msg += f"ã‚¨ãƒ©ãƒ¼è©³ç´°:\n{error_message}\n\n"
        detailed_msg += f"è§£æ±ºç­–:\n"
        detailed_msg += f"â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§é–‹ã‹ã‚Œã¦ã„ãªã„ã‹ç¢ºèª\n"
        detailed_msg += f"â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ãªã„ã‹ç¢ºèª\n"
        detailed_msg += f"â€¢ åˆ¥ã®å½¢å¼ï¼ˆExcelâ†’CSVï¼‰ã§ä¿å­˜ã—ã¦è©¦è¡Œ\n"
        detailed_msg += f"â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«æ—¥æœ¬èªã‚„ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèª\n"
        detailed_msg += f"â€¢ å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: pip install openpyxl xlrd\n\n"
        detailed_msg += f"å¯¾å¿œå½¢å¼: .xlsx, .xls, .csv, .tsv, .txt"
        
        messagebox.showerror(title, detailed_msg)
        self.progress_var.set(0)
    
    def on_data_loaded(self):
        """ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†å¾Œã®å‡¦ç†"""
        self.progress_var.set(100)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤º
        filename = os.path.basename(self.file_path)
        self.file_label.config(text=f"ğŸ“ {filename}", foreground='black')
        
        # ãƒ‡ãƒ¼ã‚¿æƒ…å ±æ›´æ–°
        self.update_data_info()
        self.update_data_table()
        
        # ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
        self.update_button_states(True)
        self.force_enable_all_export_buttons()
        
        self.log_action(f"ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: {filename}")
        self.update_status(f"âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† ({self.data.shape[0]}è¡Œ Ã— {self.data.shape[1]}åˆ—)")
        
        # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
        self.root.after(2000, lambda: self.progress_var.set(0))
    
    def force_enable_all_export_buttons_startup(self):
        """ãƒ—ãƒ­ã‚°ãƒ©ãƒ èµ·å‹•æ™‚ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«æœ‰åŠ¹åŒ–"""
        try:
            print("DEBUG: èµ·å‹•æ™‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–")
            
            # ãƒ¡ã‚¤ãƒ³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            if hasattr(self, 'main_export_button'):
                self.main_export_button.config(state='normal', bg='#4CAF50')
            
            # å€‹åˆ¥ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            if hasattr(self, 'export_excel_button'):
                self.export_excel_button.config(state='normal', bg='#2196F3')
            if hasattr(self, 'export_csv_button'):
                self.export_csv_button.config(state='normal', bg='#FF9800')
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            if hasattr(self, 'export_status'):
                self.export_status.config(text="âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œæ¨å¥¨ï¼‰", foreground='green')
            
            # GUIæ›´æ–°ã‚’å¼·åˆ¶
            self.root.update()
            self.root.update_idletasks()
            
            print("DEBUG: èµ·å‹•æ™‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–å®Œäº†")
        except Exception as e:
            print(f"ERROR: èµ·å‹•æ™‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–å¤±æ•—: {e}")

    def force_enable_all_export_buttons(self):
        """ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–"""
        if self.data is not None:
            print("DEBUG: å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶æœ‰åŠ¹åŒ–")
            
            # ãƒ¡ã‚¤ãƒ³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            self.main_export_button.config(state='normal', bg='#4CAF50')
            
            # å€‹åˆ¥ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            self.export_excel_button.config(state='normal')
            self.export_csv_button.config(state='normal')
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            self.export_status.config(text="âœ… ä¿å­˜å¯èƒ½", foreground='green')
            
            # GUIæ›´æ–°ã‚’å¼·åˆ¶
            self.root.update()
            self.root.update_idletasks()
    
    def reload_file(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†èª­ã¿è¾¼ã¿"""
        if self.file_path:
            self.load_data()
    
    def update_data_info(self):
        """ãƒ‡ãƒ¼ã‚¿æƒ…å ±ã‚’æ›´æ–°"""
        if self.data is None:
            return
        
        self.data_info = {
            'rows': len(self.data),
            'columns': len(self.data.columns),
            'empty_cells': self.data.isnull().sum().sum(),
            'duplicates': self.data.duplicated().sum(),
            'memory_usage': self.data.memory_usage(deep=True).sum()
        }
        
        # æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        info_text = f"""è¡Œæ•°: {self.data_info['rows']:,}
åˆ—æ•°: {self.data_info['columns']}
ç©ºã‚»ãƒ«æ•°: {self.data_info['empty_cells']:,}
é‡è¤‡è¡Œæ•°: {self.data_info['duplicates']:,}
ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: {self.data_info['memory_usage']/1024/1024:.2f} MB

åˆ—æƒ…å ±:"""
        
        for i, (col, dtype) in enumerate(self.data.dtypes.items()):
            null_count = self.data[col].isnull().sum()
            null_rate = (null_count / len(self.data)) * 100
            info_text += f"\n{i+1:2d}. {col[:20]:<20} | {str(dtype):<10}"
            if null_count > 0:
                info_text += f" | æ¬ æ:{null_count}({null_rate:.1f}%)"
        
        self.info_text.config(state='normal')
        self.info_text.delete(1.0, tk.END)
        self.info_text.insert(1.0, info_text)
        self.info_text.config(state='disabled')
    
    def update_data_table(self, max_rows=100):
        """ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°"""
        if self.data is None:
            return
        
        # æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        for item in self.tree.get_children():
            self.tree.delete(item)
        
        # åˆ—è¨­å®š
        columns = list(self.data.columns)
        self.tree["columns"] = columns
        self.tree["show"] = "headings"
        
        # ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
        for col in columns:
            self.tree.heading(col, text=str(col))
            self.tree.column(col, width=120, minwidth=80)
        
        # ãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼ˆæœ€å¤§100è¡Œã¾ã§ï¼‰
        display_data = self.data.head(max_rows)
        for index, row in display_data.iterrows():
            values = []
            for col in columns:
                value = row[col]
                if pd.isna(value):
                    values.append("")
                elif isinstance(value, float):
                    values.append(f"{value:.2f}" if abs(value) < 1000000 else f"{value:.2e}")
                else:
                    values.append(str(value)[:50])  # é•·ã™ãã‚‹å€¤ã‚’åˆ‡ã‚Šè©°ã‚
            self.tree.insert("", "end", values=values)
        
        # çœç•¥è¡¨ç¤º
        if len(self.data) > max_rows:
            self.tree.insert("", "end", values=[f"... ä»– {len(self.data) - max_rows} è¡Œ"] + [""] * (len(columns) - 1))
    
    def update_button_states(self, enabled=False):
        """ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°"""
        state = 'normal' if enabled else 'disabled'
        buttons = [
            self.reload_button, self.empty_rows_button, self.empty_cols_button,
            self.duplicates_button, self.missing_button, self.missing_analysis_button,
            self.text_clean_button, self.type_convert_button, self.rename_button, 
            self.filter_button, self.reset_button, self.log_button
        ]
        
        for button in buttons:
            button.config(state=state)
        
        # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã¯å¸¸ã«æœ‰åŠ¹ã«ä¿ã¤
        self.main_export_button.config(state='normal', bg='#4CAF50')
        self.export_excel_button.config(state='normal', bg='#2196F3')
        self.export_csv_button.config(state='normal', bg='#FF9800')
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        if self.data is not None:
            self.export_status.config(text="âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ¸ˆã¿ - ä¿å­˜å¯èƒ½", foreground='green')
        else:
            self.export_status.config(text="âš ï¸ ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿ - ä¿å­˜ã¯å¯èƒ½ã ãŒæ¨å¥¨ã—ãªã„", foreground='orange')
    
    def update_status(self, message):
        """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°"""
        self.status_label.config(text=message)
        self.root.update_idletasks()
    
    def log_action(self, action):
        """å‡¦ç†ãƒ­ã‚°ã‚’è¨˜éŒ²"""
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        log_entry = f"[{timestamp}] {action}"
        self.processing_log.append(log_entry)
    
    def show_error(self, message):
        """ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º"""
        messagebox.showerror("ã‚¨ãƒ©ãƒ¼", message)
        self.progress_var.set(0)
    
    def test_data_status(self):
        """ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã‚’ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰"""
        if self.data is None:
            messagebox.showinfo("ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹", 
                "âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“\n\n"
                "ğŸ“‚ ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ãƒœã‚¿ãƒ³ã§Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„")
            print("DEBUG: ãƒ‡ãƒ¼ã‚¿ãªã—")
        else:
            info = f"âœ… ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™\n\n"
            info += f"ğŸ“Š ã‚µã‚¤ã‚º: {self.data.shape[0]:,}è¡Œ Ã— {self.data.shape[1]}åˆ—\n"
            info += f"ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«: {os.path.basename(self.file_path) if self.file_path else 'N/A'}\n"
            info += f"ğŸ”§ å®Ÿè¡Œã—ãŸå‡¦ç†: {len(self.processing_log)}ä»¶\n\n"
            info += f"ãƒœã‚¿ãƒ³çŠ¶æ…‹:\n"
            info += f"â€¢ ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³: {self.main_export_button['state']}\n"
            info += f"â€¢ Excelä¿å­˜: {self.export_excel_button['state']}\n"
            info += f"â€¢ CSVä¿å­˜: {self.export_csv_button['state']}\n\n"
            
            if self.main_export_button['state'] == 'disabled':
                info += f"âš ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒç„¡åŠ¹ã§ã™\n"
                info += f"ã€ŒğŸ”§ ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„"
            else:
                info += f"âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ã§ã™ï¼"
            
            messagebox.showinfo("ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹", info)
            print(f"DEBUG: ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š - {self.data.shape}")
    
    def force_enable_export(self):
        """ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–"""
        if self.data is None:
            messagebox.showwarning("è­¦å‘Š", 
                "âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n"
                "æ‰‹é †:\n"
                "1. ğŸ“‚ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ã§Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿\n"
                "2. ã“ã®ãƒœã‚¿ãƒ³ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯")
            return
        
        # å¼·åˆ¶çš„ã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        self.main_export_button.config(state='normal', bg='#4CAF50')
        self.export_excel_button.config(state='normal')
        self.export_csv_button.config(state='normal')
        self.export_status.config(text="âœ… å¼·åˆ¶æœ‰åŠ¹åŒ–å®Œäº†", foreground='green')
        
        # GUIæ›´æ–°
        self.root.update()
        self.root.update_idletasks()
        
        # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        messagebox.showinfo("æœ‰åŠ¹åŒ–å®Œäº†", 
            "âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸï¼\n\n"
            "ğŸ“„ ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³: ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹\n"
            "ğŸ“Š Excelãƒœã‚¿ãƒ³: ç°¡å˜Excelä¿å­˜\n"
            "ğŸ“„ CSVãƒœã‚¿ãƒ³: ç°¡å˜CSVä¿å­˜\n\n"
            "ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚")
        
        print("DEBUG: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ")
    
    # ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼‰=====
    def safe_export_data(self):
        """å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        if self.data is None:
            messagebox.showwarning("ãƒ‡ãƒ¼ã‚¿ä¸è¶³", 
                "âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\n"
                "æ‰‹é †:\n"
                "1. ğŸ“‚ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ã§Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿\n"
                "2. å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’å®Ÿè¡Œ\n"
                "3. ã“ã®ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜")
            return
        
        try:
            # ä¿å­˜å…ˆæ±ºå®š
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            export_format = self.export_format.get()
            
            if self.file_path:
                base_dir = os.path.dirname(self.file_path)
                base_name = os.path.splitext(os.path.basename(self.file_path))[0]
                extension = ".xlsx" if export_format == "excel" else ".csv"
                output_path = os.path.join(base_dir, f"{base_name}_processed_{timestamp}{extension}")
            else:
                extension = ".xlsx" if export_format == "excel" else ".csv"
                output_path = f"processed_data_{timestamp}{extension}"
            
            # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            self.update_status("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...")
            self.export_status.config(text="ğŸ’¾ ä¿å­˜ä¸­...", foreground='orange')
            self.progress_var.set(10)
            
            if export_format == "excel":
                self.safe_export_excel(output_path)
            else:
                self.safe_export_csv(output_path)
            
            # æˆåŠŸå‡¦ç†
            self.export_status.config(text="âœ… ä¿å­˜å®Œäº†", foreground='green')
            self.log_action(f"ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: {os.path.basename(output_path)}")
            self.update_status(f"âœ… ä¿å­˜å®Œäº†: {os.path.basename(output_path)}")
            self.progress_var.set(100)
            
            # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‚ªãƒ¼ãƒ—ãƒ³
            self.show_export_success(output_path)
            
            # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            self.root.after(3000, lambda: self.progress_var.set(0))
            
        except Exception as e:
            self.export_status.config(text="âŒ ã‚¨ãƒ©ãƒ¼", foreground='red')
            self.show_export_error(str(e))
            self.progress_var.set(0)
    
    def safe_export_excel(self, output_path):
        """å®‰å…¨ãªExcelä¿å­˜"""
        try:
            # openpyxlã‚’ä½¿ç”¨ã—ã¦ä¿å­˜
            with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
                # ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ
                self.data.to_excel(writer, sheet_name='ProcessedData', index=False)
                self.progress_var.set(40)
                self.root.update()
                
                # å‡¦ç†ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆ
                if self.include_summary.get():
                    summary_data = self.create_processing_summary()
                    summary_df = pd.DataFrame(summary_data[1:], columns=summary_data[0])
                    summary_df.to_excel(writer, sheet_name='Summary', index=False)
                    self.progress_var.set(60)
                    self.root.update()
                
                # å‡¦ç†ãƒ­ã‚°ã‚·ãƒ¼ãƒˆ
                if self.include_log.get() and self.processing_log:
                    log_df = pd.DataFrame(self.processing_log, columns=['å‡¦ç†å±¥æ­´'])
                    log_df.to_excel(writer, sheet_name='Log', index=False)
                    self.progress_var.set(80)
                    self.root.update()
                
        except ImportError:
            # openpyxlãŒãªã„å ´åˆã¯ã‚·ãƒ³ãƒ—ãƒ«ä¿å­˜
            print("WARNING: openpyxl not available, using simple Excel export")
            self.data.to_excel(output_path, index=False)
        except Exception as e:
            print(f"ERROR: Excelä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
            # æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ç°¡å˜ä¿å­˜
            self.data.to_excel(output_path, index=False)
    
    def safe_export_csv(self, output_path):
        """å®‰å…¨ãªCSVä¿å­˜"""
        # BOMä»˜ãUTF-8ã§ä¿å­˜ï¼ˆExcelã§æ–‡å­—åŒ–ã‘ã—ãªã„ï¼‰
        self.data.to_csv(output_path, index=False, encoding='utf-8-sig')
        self.progress_var.set(60)
        self.root.update()
        
        # å‡¦ç†ã‚µãƒãƒªãƒ¼ã‚‚åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜
        if self.include_summary.get():
            summary_path = output_path.replace('.csv', '_summary.csv')
            summary_data = self.create_processing_summary()
            summary_df = pd.DataFrame(summary_data[1:], columns=summary_data[0])
            summary_df.to_csv(summary_path, index=False, encoding='utf-8-sig')
        
        # å‡¦ç†ãƒ­ã‚°ã‚‚åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜
        if self.include_log.get() and self.processing_log:
            log_path = output_path.replace('.csv', '_log.csv')
            log_df = pd.DataFrame(self.processing_log, columns=['å‡¦ç†å±¥æ­´'])
            log_df.to_csv(log_path, index=False, encoding='utf-8-sig')
        
        self.progress_var.set(90)
        self.root.update()
    
    def quick_export_excel(self):
        """ç°¡å˜Excelä¿å­˜"""
        if self.data is None:
            messagebox.showwarning("ãƒ‡ãƒ¼ã‚¿ãªã—", 
                "âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n"
                "ğŸ“‚ ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚")
            return
        
        try:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            if self.file_path:
                base_dir = os.path.dirname(self.file_path)
                base_name = os.path.splitext(os.path.basename(self.file_path))[0]
                default_path = os.path.join(base_dir, f"{base_name}_excel_{timestamp}.xlsx")
            else:
                default_path = f"data_excel_{timestamp}.xlsx"
            
            # é€²æ—è¡¨ç¤º
            self.update_status("Excelä¿å­˜ä¸­...")
            self.progress_var.set(50)
            self.root.update()
            
            # Excelä¿å­˜
            self.data.to_excel(default_path, index=False)
            
            self.progress_var.set(100)
            self.log_action(f"Excelä¿å­˜å®Œäº†: {os.path.basename(default_path)}")
            self.update_status(f"âœ… Excelä¿å­˜å®Œäº†")
            
            # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            result = messagebox.askyesno("Excelä¿å­˜å®Œäº†", 
                f"âœ… Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\n"
                f"ğŸ“ {os.path.basename(default_path)}\n"
                f"ğŸ“Š {len(self.data):,}è¡Œ Ã— {len(self.data.columns)}åˆ—\n\n"
                f"ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ")
            
            if result:
                self.open_folder(default_path)
            
            # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            self.root.after(2000, lambda: self.progress_var.set(0))
            
        except Exception as e:
            self.show_export_error(str(e))
            self.progress_var.set(0)
    
    def quick_export_csv(self):
        """ç°¡å˜CSVä¿å­˜"""
        if self.data is None:
            messagebox.showwarning("ãƒ‡ãƒ¼ã‚¿ãªã—", 
                "âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n"
                "ğŸ“‚ ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚")
            return
        
        try:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            if self.file_path:
                base_dir = os.path.dirname(self.file_path)
                base_name = os.path.splitext(os.path.basename(self.file_path))[0]
                default_path = os.path.join(base_dir, f"{base_name}_csv_{timestamp}.csv")
            else:
                default_path = f"data_csv_{timestamp}.csv"
            
            # é€²æ—è¡¨ç¤º
            self.update_status("CSVä¿å­˜ä¸­...")
            self.progress_var.set(50)
            self.root.update()
            
            # CSVä¿å­˜ï¼ˆBOMä»˜ãUTF-8ï¼‰
            self.data.to_csv(default_path, index=False, encoding='utf-8-sig')
            
            self.progress_var.set(100)
            self.log_action(f"CSVä¿å­˜å®Œäº†: {os.path.basename(default_path)}")
            self.update_status(f"âœ… CSVä¿å­˜å®Œäº†")
            
            # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            result = messagebox.askyesno("CSVä¿å­˜å®Œäº†", 
                f"âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\n"
                f"ğŸ“ {os.path.basename(default_path)}\n"
                f"ğŸ“Š {len(self.data):,}è¡Œ Ã— {len(self.data.columns)}åˆ—\n\n"
                f"ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ")
            
            if result:
                self.open_folder(default_path)
            
            # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            self.root.after(2000, lambda: self.progress_var.set(0))
            
        except Exception as e:
            self.show_export_error(str(e))
            self.progress_var.set(0)
    
    def create_processing_summary(self):
        """å‡¦ç†ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"""
        return [
            ['é …ç›®', 'å†…å®¹'],
            ['å…ƒãƒ•ã‚¡ã‚¤ãƒ«å', os.path.basename(self.file_path) if self.file_path else 'ä¸æ˜'],
            ['å‡¦ç†å®Ÿè¡Œæ—¥æ™‚', datetime.now().strftime("%Y-%m-%d %H:%M:%S")],
            ['ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º', f"{len(self.data):,}è¡Œ Ã— {len(self.data.columns)}åˆ—"],
            ['ç©ºã‚»ãƒ«æ•°', f"{self.data.isnull().sum().sum():,}å€‹"],
            ['é‡è¤‡è¡Œæ•°', f"{self.data.duplicated().sum():,}è¡Œ"],
            ['å®Ÿè¡Œå‡¦ç†æ•°', f"{len(self.processing_log)}ä»¶"],
            ['ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡', f"{self.data.memory_usage(deep=True).sum()/1024/1024:.2f} MB"],
            ['Tableauå¯¾å¿œ', 'âœ… Tableauåˆ†æç”¨ã«æœ€é©åŒ–æ¸ˆã¿'],
        ]
    
    def show_export_success(self, output_path):
        """ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"""
        file_name = os.path.basename(output_path)
        file_dir = os.path.dirname(output_path)
        file_size = os.path.getsize(output_path) / 1024  # KB
        
        success_msg = f"ğŸ‰ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n"
        success_msg += f"ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å: {file_name}\n"
        success_msg += f"ğŸ“‚ ä¿å­˜å ´æ‰€: {file_dir}\n"
        success_msg += f"ğŸ“Š ãƒ‡ãƒ¼ã‚¿: {len(self.data):,}è¡Œ Ã— {len(self.data.columns)}åˆ—\n"
        success_msg += f"ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: {file_size:.1f} KB\n"
        success_msg += f"ğŸ”§ å®Ÿè¡Œå‡¦ç†: {len(self.processing_log)}ä»¶\n\n"
        success_msg += f"ğŸš€ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Tableauã§ç›´æ¥èª­ã¿è¾¼ã‚ã¾ã™ï¼"
        
        result = messagebox.askyesno("ä¿å­˜å®Œäº†", 
            success_msg + "\n\nä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ")
        
        if result:
            self.open_folder(output_path)
    
    def show_export_error(self, error_message):
        """ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"""
        error_msg = f"âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n"
        error_msg += f"ã‚¨ãƒ©ãƒ¼è©³ç´°:\n{error_message}\n\n"
        error_msg += f"è§£æ±ºç­–:\n"
        
        if "Permission denied" in error_message or "being used" in error_message:
            error_msg += f"â€¢ åŒåãƒ•ã‚¡ã‚¤ãƒ«ãŒExcelã§é–‹ã‹ã‚Œã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã¦ãã ã•ã„\n"
            error_msg += f"â€¢ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n"
        elif "openpyxl" in error_message:
            error_msg += f"â€¢ pip install openpyxl ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„\n"
        else:
            error_msg += f"â€¢ åˆ¥ã®å½¢å¼ï¼ˆCSVï¼‰ã‚’è©¦ã—ã¦ãã ã•ã„\n"
            error_msg += f"â€¢ åˆ¥ã®ä¿å­˜å ´æ‰€ã‚’è©¦ã—ã¦ãã ã•ã„\n"
        
        error_msg += f"\nğŸ’¡ ã€ŒğŸ”§ ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„"
        
        messagebox.showerror("ä¿å­˜ã‚¨ãƒ©ãƒ¼", error_msg)
    
    def open_folder(self, file_path):
        """ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã"""
        try:
            import platform
            import subprocess
            
            system = platform.system()
            folder_path = os.path.dirname(file_path)
            
            if system == "Windows":
                subprocess.run(['explorer', '/select,', file_path.replace('/', '\\')])
            elif system == "Darwin":  # macOS
                subprocess.run(['open', '-R', file_path])
            else:  # Linux
                subprocess.run(['xdg-open', folder_path])
                
        except Exception as e:
            print(f"ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: {e}")
            try:
                # ãƒ•ã‚©ãƒ«ãƒ€ã ã‘é–‹ã
                folder_path = os.path.dirname(file_path)
                if platform.system() == "Windows":
                    os.startfile(folder_path)
                else:
                    os.system(f"open '{folder_path}'" if platform.system() == "Darwin" else f"xdg-open '{folder_path}'")
            except:
                pass
    
    # ===== ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰ =====
    def remove_empty_rows(self):
        """ç©ºè¡Œã‚’å‰Šé™¤"""
        if self.data is None:
            return
        
        try:
            initial_rows = len(self.data)
            self.data = self.data.dropna(how='all')
            removed_rows = initial_rows - len(self.data)
            
            self.update_data_info()
            self.update_data_table()
            
            self.log_action(f"ç©ºè¡Œå‰Šé™¤: {removed_rows}è¡Œå‰Šé™¤")
            self.update_status(f"âœ… {removed_rows}è¡Œã®ç©ºè¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
            
        except Exception as e:
            self.show_error(f"ç©ºè¡Œå‰Šé™¤ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    def remove_empty_columns(self):
        """ç©ºåˆ—ã‚’å‰Šé™¤"""
        if self.data is None:
            return
        
        try:
            initial_cols = len(self.data.columns)
            self.data = self.data.dropna(axis=1, how='all')
            removed_cols = initial_cols - len(self.data.columns)
            
            self.update_data_info()
            self.update_data_table()
            
            self.log_action(f"ç©ºåˆ—å‰Šé™¤: {removed_cols}åˆ—å‰Šé™¤")
            self.update_status(f"âœ… {removed_cols}åˆ—ã®ç©ºåˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
            
        except Exception as e:
            self.show_error(f"ç©ºåˆ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    def remove_duplicates(self):
        """é‡è¤‡è¡Œã‚’å‰Šé™¤"""
        if self.data is None:
            return
        
        try:
            initial_rows = len(self.data)
            self.data = self.data.drop_duplicates()
            removed_rows = initial_rows - len(self.data)
            
            self.update_data_info()
            self.update_data_table()
            
            self.log_action(f"é‡è¤‡è¡Œå‰Šé™¤: {removed_rows}è¡Œå‰Šé™¤")
            self.update_status(f"âœ… {removed_rows}è¡Œã®é‡è¤‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
            
        except Exception as e:
            self.show_error(f"é‡è¤‡è¡Œå‰Šé™¤ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    def clean_text_data(self):
        """ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°"""
        if self.data is None:
            return
        
        try:
            text_columns = self.data.select_dtypes(include=['object']).columns
            processed_cols = 0
            
            for col in text_columns:
                # å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
                self.data[col] = self.data[col].astype(str).str.strip()
                # é€£ç¶šã™ã‚‹ç©ºç™½ã‚’1ã¤ã«
                self.data[col] = self.data[col].str.replace(r'\s+', ' ', regex=True)
                processed_cols += 1
            
            self.update_data_info()
            self.update_data_table()
            
            self.log_action(f"ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°: {processed_cols}åˆ—å‡¦ç†")
            self.update_status(f"âœ… {processed_cols}åˆ—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´å½¢ã—ã¾ã—ãŸ")
            
        except Exception as e:
            self.show_error(f"ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    def convert_data_types(self):
        """ãƒ‡ãƒ¼ã‚¿å‹ã‚’å¤‰æ›"""
        if self.data is None:
            return
        
        try:
            converted_cols = 0
            
            for col in self.data.columns:
                if self.data[col].dtype == 'object':
                    # æ•°å€¤å¤‰æ›ã‚’è©¦è¡Œ
                    numeric_series = pd.to_numeric(self.data[col], errors='coerce')
                    if numeric_series.notna().sum() / len(self.data[col]) > 0.8:
                        self.data[col] = numeric_series
                        converted_cols += 1
                    else:
                        # æ—¥ä»˜å¤‰æ›ã‚’è©¦è¡Œ
                        try:
                            date_series = pd.to_datetime(self.data[col], errors='coerce')
                            if date_series.notna().sum() / len(self.data[col]) > 0.5:
                                self.data[col] = date_series
                                converted_cols += 1
                        except:
                            pass
            
            self.update_data_info()
            self.update_data_table()
            
            self.log_action(f"ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›: {converted_cols}åˆ—å¤‰æ›")
            self.update_status(f"âœ… {converted_cols}åˆ—ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’å¤‰æ›ã—ã¾ã—ãŸ")
            
        except Exception as e:
            self.show_error(f"ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    def fill_missing_dialog(self):
        """æ¬ æå€¤å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º"""
        if self.data is None:
            return
        
        dialog = tk.Toplevel(self.root)
        dialog.title("æ¬ æå€¤å‡¦ç†")
        dialog.geometry("450x350")
        dialog.transient(self.root)
        dialog.grab_set()
        
        # å‡¦ç†æ–¹æ³•é¸æŠ
        ttk.Label(dialog, text="å‡¦ç†æ–¹æ³•ã‚’é¸æŠ:", font=('Arial', 11, 'bold')).pack(pady=10)
        
        method_var = tk.StringVar(value='remove')
        methods = [
            ('remove', 'ğŸ—‘ï¸ ç©ºè¡Œã‚’å‰Šé™¤'),
            ('mean', 'ğŸ“Š å¹³å‡å€¤ã§åŸ‹ã‚ã‚‹ï¼ˆæ•°å€¤åˆ—ã®ã¿ï¼‰'),
            ('median', 'ğŸ“ˆ ä¸­å¤®å€¤ã§åŸ‹ã‚ã‚‹ï¼ˆæ•°å€¤åˆ—ã®ã¿ï¼‰'),
            ('forward', 'â¬†ï¸ å‰ã®å€¤ã§åŸ‹ã‚ã‚‹'),
            ('backward', 'â¬‡ï¸ æ¬¡ã®å€¤ã§åŸ‹ã‚ã‚‹'),
            ('zero', '0ï¸âƒ£ ã‚¼ãƒ­ã§åŸ‹ã‚ã‚‹'),
            ('custom', 'âœï¸ ã‚«ã‚¹ã‚¿ãƒ å€¤ã§åŸ‹ã‚ã‚‹')
        ]
        
        # ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ã«é…ç½®
        radio_frame = ttk.Frame(dialog)
        radio_frame.pack(pady=10, padx=20, fill=tk.X)
        
        for value, text in methods:
            ttk.Radiobutton(radio_frame, text=text, variable=method_var, value=value).pack(anchor=tk.W, pady=2)
        
        # æƒ…å ±è¡¨ç¤º
        info_frame = ttk.LabelFrame(dialog, text="ğŸ“Š ãƒ‡ãƒ¼ã‚¿æƒ…å ±", padding="10")
        info_frame.pack(pady=10, padx=20, fill=tk.X)
        
        # æ•°å€¤åˆ—ã®æƒ…å ±ã‚’è¡¨ç¤º
        numeric_cols = self.data.select_dtypes(include=[np.number]).columns.tolist()
        text_cols = self.data.select_dtypes(include=['object']).columns.tolist()
        total_nulls = self.data.isnull().sum().sum()
        
        info_text = f"ğŸ“ˆ æ•°å€¤åˆ—: {len(numeric_cols)}åˆ— (å¹³å‡å€¤/ä¸­å¤®å€¤å¯¾è±¡)\n"
        info_text += f"ğŸ“ æ–‡å­—åˆ—åˆ—: {len(text_cols)}åˆ—\n"
        info_text += f"ğŸ” ç·æ¬ æå€¤: {total_nulls:,}å€‹"
        
        ttk.Label(info_frame, text=info_text, font=('Arial', 9)).pack()
        
        # ã‚«ã‚¹ã‚¿ãƒ å€¤å…¥åŠ›
        custom_frame = ttk.LabelFrame(dialog, text="ã‚«ã‚¹ã‚¿ãƒ è¨­å®š", padding="10")
        custom_frame.pack(pady=10, padx=20, fill=tk.X)
        
        ttk.Label(custom_frame, text="ã‚«ã‚¹ã‚¿ãƒ å€¤:").pack(side=tk.LEFT)
        custom_var = tk.StringVar()
        custom_entry = ttk.Entry(custom_frame, textvariable=custom_var, width=15)
        custom_entry.pack(side=tk.LEFT, padx=5)
        
        # ãƒœã‚¿ãƒ³
        button_frame = ttk.Frame(dialog)
        button_frame.pack(pady=20)
        
        def apply_fill():
            try:
                method = method_var.get()
                initial_nulls = self.data.isnull().sum().sum()
                
                if method == 'remove':
                    self.data = self.data.dropna()
                    
                elif method == 'mean':
                    # å¹³å‡å€¤ã§åŸ‹ã‚ã‚‹ï¼ˆæ•°å€¤åˆ—ã®ã¿ï¼‰
                    numeric_columns = self.data.select_dtypes(include=[np.number]).columns
                    filled_cols = 0
                    for col in numeric_columns:
                        if self.data[col].isnull().any():
                            mean_value = self.data[col].mean()
                            self.data[col] = self.data[col].fillna(mean_value)
                            filled_cols += 1
                    
                    if filled_cols == 0:
                        messagebox.showinfo("æƒ…å ±", "æ•°å€¤åˆ—ã«æ¬ æå€¤ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                        dialog.destroy()
                        return
                        
                elif method == 'median':
                    # ä¸­å¤®å€¤ã§åŸ‹ã‚ã‚‹ï¼ˆæ•°å€¤åˆ—ã®ã¿ï¼‰
                    numeric_columns = self.data.select_dtypes(include=[np.number]).columns
                    filled_cols = 0
                    for col in numeric_columns:
                        if self.data[col].isnull().any():
                            median_value = self.data[col].median()
                            self.data[col] = self.data[col].fillna(median_value)
                            filled_cols += 1
                    
                    if filled_cols == 0:
                        messagebox.showinfo("æƒ…å ±", "æ•°å€¤åˆ—ã«æ¬ æå€¤ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                        dialog.destroy()
                        return
                        
                elif method == 'forward':
                    self.data = self.data.fillna(method='ffill')
                    
                elif method == 'backward':
                    self.data = self.data.fillna(method='bfill')
                    
                elif method == 'zero':
                    self.data = self.data.fillna(0)
                    
                elif method == 'custom':
                    custom_value = custom_var.get()
                    if not custom_value:
                        messagebox.showwarning("è­¦å‘Š", "ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                        return
                    
                    # æ•°å€¤ã¨ã—ã¦èªè­˜å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                    try:
                        float(custom_value)
                        # æ•°å€¤ã¨ã—ã¦ä½¿ç”¨
                        self.data = self.data.fillna(pd.to_numeric(custom_value, errors='ignore'))
                    except ValueError:
                        # æ–‡å­—åˆ—ã¨ã—ã¦ä½¿ç”¨
                        self.data = self.data.fillna(custom_value)
                
                final_nulls = self.data.isnull().sum().sum()
                processed_count = initial_nulls - final_nulls
                
                self.update_data_info()
                self.update_data_table()
                
                method_names = {
                    'remove': 'ç©ºè¡Œå‰Šé™¤',
                    'mean': 'å¹³å‡å€¤è£œå®Œ',
                    'median': 'ä¸­å¤®å€¤è£œå®Œ', 
                    'forward': 'å‰æ–¹å€¤è£œå®Œ',
                    'backward': 'å¾Œæ–¹å€¤è£œå®Œ',
                    'zero': 'ã‚¼ãƒ­è£œå®Œ',
                    'custom': 'ã‚«ã‚¹ã‚¿ãƒ å€¤è£œå®Œ'
                }
                
                self.log_action(f"æ¬ æå€¤å‡¦ç†: {processed_count}å€‹å‡¦ç† (æ–¹æ³•: {method_names.get(method, method)})")
                self.update_status(f"âœ… {processed_count}å€‹ã®æ¬ æå€¤ã‚’å‡¦ç†ã—ã¾ã—ãŸ ({method_names.get(method, method)})")
                
                # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                success_msg = f"ğŸ‰ æ¬ æå€¤å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n"
                success_msg += f"ğŸ“Š å‡¦ç†æ–¹æ³•: {method_names.get(method, method)}\n"
                success_msg += f"ğŸ”§ å‡¦ç†æ•°: {processed_count:,}å€‹\n"
                success_msg += f"ğŸ“‰ æ®‹ã‚Šæ¬ æå€¤: {final_nulls:,}å€‹"
                
                if method in ['mean', 'median'] and processed_count > 0:
                    success_msg += f"\n\nğŸ’¡ æ•°å€¤åˆ—ã®ã¿ãŒå¯¾è±¡ã§ã™ã€‚æ–‡å­—åˆ—åˆ—ã®æ¬ æå€¤ã¯åˆ¥é€”å‡¦ç†ã—ã¦ãã ã•ã„ã€‚"
                
                messagebox.showinfo("å‡¦ç†å®Œäº†", success_msg)
                
                dialog.destroy()
                
            except Exception as e:
                error_msg = f"æ¬ æå€¤å‡¦ç†ã‚¨ãƒ©ãƒ¼: {str(e)}\n\n"
                
                if "mean" in str(e) or "median" in str(e):
                    error_msg += "ğŸ’¡ æ•°å€¤åˆ—ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
                    
                messagebox.showerror("ã‚¨ãƒ©ãƒ¼", error_msg)
        
        ttk.Button(button_frame, text="âœ… é©ç”¨", command=apply_fill, style='Action.TButton').pack(side=tk.LEFT, padx=5)
        ttk.Button(button_frame, text="âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", command=dialog.destroy).pack(side=tk.LEFT, padx=5)
    
    def show_missing_analysis(self):
        """æ¬ æå€¤åˆ†æã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º"""
        if self.data is None:
            return
        
        # åˆ†æã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
        analysis_window = tk.Toplevel(self.root)
        analysis_window.title("ğŸ“Š æ¬ æå€¤åˆ†æãƒ¬ãƒãƒ¼ãƒˆ")
        analysis_window.geometry("800x600")
        analysis_window.transient(self.root)
        
        # ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
        text_widget = scrolledtext.ScrolledText(analysis_window, wrap=tk.WORD, 
                                               font=('Consolas', 10), bg='#f8f8f8')
        text_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # åˆ†æçµæœã‚’ç”Ÿæˆ
        analysis_report = self.generate_missing_analysis_report()
        
        # ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«æŒ¿å…¥
        text_widget.insert(tk.END, analysis_report)
        text_widget.config(state='disabled')
        
        # é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        close_button = ttk.Button(analysis_window, text="é–‰ã˜ã‚‹", 
                                 command=analysis_window.destroy)
        close_button.pack(pady=10)
    
    def generate_missing_analysis_report(self):
        """æ¬ æå€¤åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        report = "ğŸ“Š æ¬ æå€¤åˆ†æãƒ¬ãƒãƒ¼ãƒˆ\n"
        report += "=" * 60 + "\n\n"
        
        # åŸºæœ¬çµ±è¨ˆ
        total_cells = self.data.shape[0] * self.data.shape[1]
        total_missing = self.data.isnull().sum().sum()
        missing_percentage = (total_missing / total_cells) * 100
        
        report += f"ğŸ“ˆ å…¨ä½“çµ±è¨ˆ:\n"
        report += f"  â€¢ ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: {self.data.shape[0]:,} è¡Œ Ã— {self.data.shape[1]} åˆ—\n"
        report += f"  â€¢ ç·ã‚»ãƒ«æ•°: {total_cells:,} ã‚»ãƒ«\n"
        report += f"  â€¢ æ¬ æã‚»ãƒ«æ•°: {total_missing:,} ã‚»ãƒ« ({missing_percentage:.2f}%)\n"
        report += f"  â€¢ å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿è¡Œ: {self.data.dropna().shape[0]:,} è¡Œ\n\n"
        
        # åˆ—åˆ¥æ¬ æçŠ¶æ³
        missing_by_column = self.data.isnull().sum().sort_values(ascending=False)
        missing_cols = missing_by_column[missing_by_column > 0]
        
        if len(missing_cols) > 0:
            report += f"ğŸ“‹ åˆ—åˆ¥æ¬ æçŠ¶æ³ (æ¬ æå€¤ãŒå¤šã„é †):\n"
            report += "-" * 50 + "\n"
            
            for col, missing_count in missing_cols.items():
                missing_rate = (missing_count / len(self.data)) * 100
                data_type = str(self.data[col].dtype)
                
                report += f"  {col[:30]:<30} | {missing_count:>6} ({missing_rate:>5.1f}%) | {data_type}\n"
            
            report += "\n"
        else:
            report += f"âœ… æ¬ æå€¤ã¯ã‚ã‚Šã¾ã›ã‚“ï¼\n\n"
        
        # æ•°å€¤åˆ—ã®çµ±è¨ˆæƒ…å ±
        numeric_cols = self.data.select_dtypes(include=[np.number]).columns
        if len(numeric_cols) > 0:
            report += f"ğŸ”¢ æ•°å€¤åˆ—ã®çµ±è¨ˆæƒ…å ±:\n"
            report += "-" * 70 + "\n"
            report += f"{'åˆ—å':<25} | {'æ¬ ææ•°':<6} | {'å¹³å‡å€¤':<10} | {'ä¸­å¤®å€¤':<10} | {'æ¨™æº–åå·®':<10}\n"
            report += "-" * 70 + "\n"
            
            for col in numeric_cols:
                missing_count = self.data[col].isnull().sum()
                if missing_count > 0 or True:  # ã™ã¹ã¦ã®æ•°å€¤åˆ—ã‚’è¡¨ç¤º
                    mean_val = self.data[col].mean()
                    median_val = self.data[col].median()
                    std_val = self.data[col].std()
                    
                    report += f"{col[:24]:<25} | {missing_count:<6} | {mean_val:<10.2f} | {median_val:<10.2f} | {std_val:<10.2f}\n"
            
            report += "\n"
        
        # æ¬ æãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
        if total_missing > 0:
            report += f"ğŸ” æ¬ æãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ:\n"
            report += "-" * 40 + "\n"
            
            # å®Œå…¨æ¬ æè¡Œ
            completely_missing_rows = self.data.isnull().all(axis=1).sum()
            if completely_missing_rows > 0:
                report += f"  â€¢ å®Œå…¨æ¬ æè¡Œ: {completely_missing_rows} è¡Œ\n"
            
            # éƒ¨åˆ†æ¬ æè¡Œ
            partially_missing_rows = (self.data.isnull().any(axis=1) & ~self.data.isnull().all(axis=1)).sum()
            if partially_missing_rows > 0:
                report += f"  â€¢ éƒ¨åˆ†æ¬ æè¡Œ: {partially_missing_rows} è¡Œ\n"
            
            # å®Œå…¨æ¬ æåˆ—
            completely_missing_cols = self.data.isnull().all(axis=0).sum()
            if completely_missing_cols > 0:
                report += f"  â€¢ å®Œå…¨æ¬ æåˆ—: {completely_missing_cols} åˆ—\n"
            
            report += "\n"
        
        # æ¨å¥¨å‡¦ç†æ–¹æ³•
        report += f"ğŸ’¡ æ¨å¥¨å‡¦ç†æ–¹æ³•:\n"
        report += "-" * 30 + "\n"
        
        if missing_percentage < 5:
            report += f"  âœ… æ¬ æç‡ãŒä½ã„({missing_percentage:.1f}%) â†’ è¡Œå‰Šé™¤ã‚’æ¨å¥¨\n"
        elif missing_percentage < 15:
            report += f"  âš ï¸  æ¬ æç‡ãŒä¸­ç¨‹åº¦({missing_percentage:.1f}%) â†’ å¹³å‡å€¤/ä¸­å¤®å€¤è£œå®Œã‚’æ¨å¥¨\n"
        else:
            report += f"  âš ï¸  æ¬ æç‡ãŒé«˜ã„({missing_percentage:.1f}%) â†’ æ…é‡ãªæ¤œè¨ãŒå¿…è¦\n"
        
        # æ•°å€¤åˆ—ã®å‡¦ç†æ¨å¥¨
        if len(numeric_cols) > 0:
            report += f"\nğŸ“Š æ•°å€¤åˆ—ã®å‡¦ç†æ¨å¥¨:\n"
            for col in numeric_cols:
                missing_count = self.data[col].isnull().sum()
                if missing_count > 0:
                    missing_rate = (missing_count / len(self.data)) * 100
                    std_val = self.data[col].std()
                    mean_val = self.data[col].mean()
                    
                    if missing_rate < 10:
                        if std_val / mean_val < 0.5:  # å¤‰å‹•ä¿‚æ•°ãŒå°ã•ã„
                            report += f"  â€¢ {col}: å¹³å‡å€¤è£œå®Œæ¨å¥¨ (å®‰å®šã—ãŸãƒ‡ãƒ¼ã‚¿)\n"
                        else:
                            report += f"  â€¢ {col}: ä¸­å¤®å€¤è£œå®Œæ¨å¥¨ (ã°ã‚‰ã¤ããŒå¤§ãã„)\n"
                    else:
                        report += f"  â€¢ {col}: æ…é‡ãªæ¤œè¨ãŒå¿…è¦ (æ¬ æç‡{missing_rate:.1f}%)\n"
        
        report += "\n" + "=" * 60 + "\n"
        report += f"ğŸ“… åˆ†æå®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
        
        return report
    
    def rename_columns_dialog(self):
        """åˆ—åå¤‰æ›´ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º"""
        if self.data is None:
            return
        
        dialog = tk.Toplevel(self.root)
        dialog.title("åˆ—åå¤‰æ›´")
        dialog.geometry("500x300")
        dialog.transient(self.root)
        dialog.grab_set()
        
        # åˆ—ãƒªã‚¹ãƒˆ
        ttk.Label(dialog, text="å¤‰æ›´ã™ã‚‹åˆ—ã‚’é¸æŠ:", font=('Arial', 10, 'bold')).pack(pady=10)
        
        list_frame = ttk.Frame(dialog)
        list_frame.pack(fill=tk.BOTH, expand=True, padx=20)
        
        listbox = tk.Listbox(list_frame)
        scrollbar = ttk.Scrollbar(list_frame, orient=tk.VERTICAL, command=listbox.yview)
        listbox.config(yscrollcommand=scrollbar.set)
        
        for col in self.data.columns:
            listbox.insert(tk.END, col)
        
        listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # æ–°ã—ã„åå‰å…¥åŠ›
        input_frame = ttk.Frame(dialog)
        input_frame.pack(pady=10)
        ttk.Label(input_frame, text="æ–°ã—ã„åˆ—å:").pack(side=tk.LEFT)
        new_name_var = tk.StringVar()
        ttk.Entry(input_frame, textvariable=new_name_var).pack(side=tk.LEFT, padx=5)
        
        # ãƒœã‚¿ãƒ³
        button_frame = ttk.Frame(dialog)
        button_frame.pack(pady=20)
        
        def apply_rename():
            try:
                selection = listbox.curselection()
                if not selection:
                    messagebox.showwarning("è­¦å‘Š", "åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„")
                    return
                
                old_name = listbox.get(selection[0])
                new_name = new_name_var.get().strip()
                
                if not new_name:
                    messagebox.showwarning("è­¦å‘Š", "æ–°ã—ã„åˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                    return
                
                self.data = self.data.rename(columns={old_name: new_name})
                
                self.update_data_info()
                self.update_data_table()
                
                self.log_action(f"åˆ—åå¤‰æ›´: {old_name} -> {new_name}")
                self.update_status(f"âœ… åˆ—åã‚’å¤‰æ›´ã—ã¾ã—ãŸ: {old_name} -> {new_name}")
                
                dialog.destroy()
                
            except Exception as e:
                messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"åˆ—åå¤‰æ›´ã‚¨ãƒ©ãƒ¼: {str(e)}")
        
        ttk.Button(button_frame, text="å¤‰æ›´", command=apply_rename).pack(side=tk.LEFT, padx=5)
        ttk.Button(button_frame, text="ã‚­ãƒ£ãƒ³ã‚»ãƒ«", command=dialog.destroy).pack(side=tk.LEFT, padx=5)
    
    def filter_data_dialog(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º"""
        if self.data is None:
            return
        
        dialog = tk.Toplevel(self.root)
        dialog.title("ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿")
        dialog.geometry("450x250")
        dialog.transient(self.root)
        dialog.grab_set()
        
        # åˆ—é¸æŠ
        ttk.Label(dialog, text="ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹åˆ—:", font=('Arial', 10, 'bold')).pack(pady=5)
        column_var = tk.StringVar()
        column_combo = ttk.Combobox(dialog, textvariable=column_var, values=list(self.data.columns))
        column_combo.pack(pady=5)
        
        # æ¡ä»¶é¸æŠ
        ttk.Label(dialog, text="æ¡ä»¶:", font=('Arial', 10, 'bold')).pack(pady=5)
        condition_var = tk.StringVar(value='==')
        conditions = ['==', '!=', '>', '<', '>=', '<=', 'contains']
        condition_combo = ttk.Combobox(dialog, textvariable=condition_var, values=conditions)
        condition_combo.pack(pady=5)
        
        # å€¤å…¥åŠ›
        ttk.Label(dialog, text="å€¤:", font=('Arial', 10, 'bold')).pack(pady=5)
        value_var = tk.StringVar()
        ttk.Entry(dialog, textvariable=value_var).pack(pady=5)
        
        # ãƒœã‚¿ãƒ³
        button_frame = ttk.Frame(dialog)
        button_frame.pack(pady=20)
        
        def apply_filter():
            try:
                column = column_var.get()
                condition = condition_var.get()
                value = value_var.get()
                
                if not column or column not in self.data.columns:
                    messagebox.showwarning("è­¦å‘Š", "æœ‰åŠ¹ãªåˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„")
                    return
                
                if not value:
                    messagebox.showwarning("è­¦å‘Š", "ãƒ•ã‚£ãƒ«ã‚¿å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                    return
                
                initial_rows = len(self.data)
                
                if condition == '==':
                    self.data = self.data[self.data[column] == value]
                elif condition == '!=':
                    self.data = self.data[self.data[column] != value]
                elif condition == '>':
                    self.data = self.data[pd.to_numeric(self.data[column], errors='coerce') > float(value)]
                elif condition == '<':
                    self.data = self.data[pd.to_numeric(self.data[column], errors='coerce') < float(value)]
                elif condition == '>=':
                    self.data = self.data[pd.to_numeric(self.data[column], errors='coerce') >= float(value)]
                elif condition == '<=':
                    self.data = self.data[pd.to_numeric(self.data[column], errors='coerce') <= float(value)]
                elif condition == 'contains':
                    self.data = self.data[self.data[column].astype(str).str.contains(value, na=False)]
                
                filtered_rows = initial_rows - len(self.data)
                
                self.update_data_info()
                self.update_data_table()
                
                self.log_action(f"ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿: {column} {condition} {value} ({filtered_rows}è¡Œé™¤å¤–)")
                self.update_status(f"âœ… {filtered_rows}è¡Œã‚’ãƒ•ã‚£ãƒ«ã‚¿ã—ã¾ã—ãŸ")
                
                dialog.destroy()
                
            except Exception as e:
                messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒ©ãƒ¼: {str(e)}")
        
        ttk.Button(button_frame, text="é©ç”¨", command=apply_filter).pack(side=tk.LEFT, padx=5)
        ttk.Button(button_frame, text="ã‚­ãƒ£ãƒ³ã‚»ãƒ«", command=dialog.destroy).pack(side=tk.LEFT, padx=5)
    
    def reset_data(self):
        """ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ"""
        if self.original_data is None:
            return
        
        if messagebox.askyesno("ç¢ºèª", "ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã™ã¹ã¦ã®å¤‰æ›´ãŒå¤±ã‚ã‚Œã¾ã™ã€‚"):
            self.data = self.original_data.copy()
            self.update_data_info()
            self.update_data_table()
            self.processing_log = []
            self.log_action("ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå®Œäº†")
            self.update_status("âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ")
    
    def show_processing_log(self):
        """å‡¦ç†ãƒ­ã‚°ã‚’è¡¨ç¤º"""
        if not self.processing_log:
            messagebox.showinfo("å‡¦ç†ãƒ­ã‚°", "å‡¦ç†ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“")
            return
        
        log_window = tk.Toplevel(self.root)
        log_window.title("å‡¦ç†ãƒ­ã‚°")
        log_window.geometry("600x400")
        
        text_widget = scrolledtext.ScrolledText(log_window, wrap=tk.WORD, font=('Consolas', 9))
        text_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        for log in self.processing_log:
            text_widget.insert(tk.END, log + '\n')
        
        text_widget.config(state='disabled')


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    root = tk.Tk()
    app = TableauPreprocessorGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
